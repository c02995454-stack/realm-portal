<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Realms App - Secure Cloud Sync</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/open-location-code@1.0.3/js/openlocationcode.min.js"></script>

    <style>
      body, html { margin: 0; padding: 0; min-height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
      #root { min-height: 100vh; }
      
      #notification-banner {
        position: fixed; top: -100px; left: 0; right: 0; padding: 15px;
        background: #ff5252; color: white; text-align: center;
        font-weight: bold; font-size: 14px; z-index: 10001;
        transition: transform 0.4s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      }
      #notification-banner.active { transform: translateY(100px); }

      .scroll-box::-webkit-scrollbar { width: 6px; }
      .scroll-box::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
      .scroll-box::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
      
      .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
      .dot-active { background-color: #4db6ac; box-shadow: 0 0 8px #4db6ac; }
      .dot-inactive { background-color: #ff8a65; }
      
      .late-tag { 
        font-size: 10px; background: #ff5252; color: white; padding: 2px 6px; 
        border-radius: 4px; margin-left: 8px; cursor: help; font-weight: bold; display: inline-block;
      }
      .consistency-tag {
        font-size: 9px; background: #d32f2f; color: white; padding: 2px 5px;
        border-radius: 4px; margin-left: 5px; font-weight: bold; animation: pulse 2s infinite;
      }
      .history-item {
        background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; margin-bottom: 5px;
        font-size: 12px; display: flex; justify-content: space-between;
      }
      .admin-history-row { background: rgba(0,0,0,0.2); font-size: 11px; }
      .clickable-name { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }
      .clickable-name:hover { color: #4db6ac; }
      
      .download-btn {
        background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
        color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;
      }
      .download-btn:hover { background: rgba(255,255,255,0.2); }
      
      .filter-input {
        background: rgba(255,255,255,0.9); border: none; border-radius: 6px; padding: 5px;
        font-size: 11px; color: #333; width: 100%;
      }
      .reset-btn {
        background: rgba(255,50,50,0.2); border: 1px solid rgba(255,255,255,0.2);
        color: white; padding: 5px 10px; border-radius: 6px; font-size: 11px; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
      }

      .stat-grid {
        display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px;
      }
      .stat-box {
        background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; text-align: center;
      }
      .stat-label { font-size: 9px; opacity: 0.7; text-transform: uppercase; letter-spacing: 0.5px; }
      .stat-value { font-size: 14px; font-weight: bold; color: #fff; }
      .stat-value.alert { color: #ff8a65; }

      @keyframes pulse {
        0% { transform: scale(0.95); opacity: 0.7; }
        50% { transform: scale(1.05); opacity: 1; }
        100% { transform: scale(0.95); opacity: 0.7; }
      }
      .loading-pulse { animation: pulse 1.5s infinite ease-in-out; }

      @media (max-width: 600px) {
        .stat-grid { grid-template-columns: repeat(2, 1fr); }
        .admin-controls-flex { flex-direction: column; align-items: stretch !important; gap: 10px !important; }
        .date-filter-group { justify-content: space-between !important; width: 100%; }
        .filter-input { width: 45%; }
        .card-container { padding: 20px !important; border-radius: 15px !important; width: 95% !important; margin: 10px auto; }
        h1 { font-size: 18px !important; }
        .stat-value { font-size: 12px; }
      }
    </style>
  </head>
  <body>
    <div id="notification-banner">Notification</div>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;

      const firebaseConfig = {
        apiKey: "AIzaSyCsYQXulW8xiug_BMlMx4Exmtt7BSTllX8",
        authDomain: "realms-logs.firebaseapp.com",
        projectId: "realms-logs",
        storageBucket: "realms-logs.firebasestorage.app",
        messagingSenderId: "746390811725",
        appId: "1:746390811725:web:455ec375d3f9e9f8605804"
      };

      if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
      const db = firebase.firestore();

      // PUBLIC Schedule data only
      const SCHEDULE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT-nOcEjfqKJsQVLP91tE0cw-_LXGNO6XcjDYC-CAphU6-fAlAizYkT-ZdFaaHMIzr3t602r11a_J5B/pub?gid=1411884124&single=true&output=csv"; 
      const LOGO_URL = "https://i.postimg.cc/5YVQFmvK/EFA-Logos-(2)-(1).png"; 

      function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      }

      function App() {
        const [combinedCode, setCombinedCode] = useState("");
        const [isVerifying, setIsVerifying] = useState(false);
        const [searchTerm, setSearchTerm] = useState("");
        const [user, setUser] = useState(null);
        const [logs, setLogs] = useState([]);
        const [scheduleList, setScheduleList] = useState([]);
        const [loading, setLoading] = useState(true);
        const [currentTime, setCurrentTime] = useState(new Date());
        const [timer, setTimer] = useState(300);
        const [lastClockInfo, setLastClockInfo] = useState("");
        const [expandedStaff, setExpandedStaff] = useState(null);
        const [startDate, setStartDate] = useState("");
        const [endDate, setEndDate] = useState("");

        const triggerNotify = (text, isError = true) => {
          const banner = document.getElementById('notification-banner');
          banner.innerText = text;
          banner.style.background = isError ? "#ff5252" : "#4db6ac";
          banner.classList.add('active');
          setTimeout(() => banner.classList.remove('active'), 5000);
        };

        useEffect(() => {
          const clockInterval = setInterval(() => setCurrentTime(new Date()), 1000);
          return () => clearInterval(clockInterval);
        }, []);

        useEffect(() => {
          if (user) {
            const initialTime = user.role === 'admin' ? 300 : 60;
            setTimer(initialTime); 
            const countdown = setInterval(() => {
              setTimer((prev) => {
                if (prev <= 1) { handleLogout(); return initialTime; }
                return prev - 1;
              });
            }, 1000);
            return () => clearInterval(countdown);
          }
        }, [user]);

        const handleLogout = () => {
          setUser(null); setCombinedCode(""); setSearchTerm(""); setLastClockInfo(""); setExpandedStaff(null);
          setStartDate(""); setEndDate(""); setIsVerifying(false);
        };

        const formatTimer = (seconds) => {
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return `${mins}:${secs.toString().padStart(2, '0')}`;
        };

        useEffect(() => {
          // Fetch only the Schedule/Geofence data from CSV
          fetch(SCHEDULE_SHEET_URL)
            .then(res => res.text())
            .then(scheduleCsv => {
              setScheduleList(scheduleCsv.split("\n").slice(1).map(line => {
                const p = line.split(",");
                return { 
                  schoolName: p[0]?.trim(), 
                  districtCode: p[1]?.trim(), 
                  lateTime: p[2]?.trim(),
                  lat: parseFloat(p[3]?.trim()),
                  lon: parseFloat(p[4]?.trim()),
                  radius: parseFloat(p[5]?.trim()) || 0.5 
                };
              }));
              setLoading(false);
            })
            .catch(() => setLoading(false));

          const unsubscribe = db.collection("logs")
            .orderBy("timestamp", "desc")
            .onSnapshot((snapshot) => {
              setLogs(snapshot.docs.map(doc => ({
                ...doc.data(),
                id: doc.id,
                rawDate: doc.data().timestamp ? doc.data().timestamp.toDate() : null,
                time: doc.data().timestamp ? doc.data().timestamp.toDate().toLocaleString() : "Syncing..."
              })));
            });
          return () => unsubscribe();
        }, []);

        const filteredLogs = useMemo(() => {
          return logs.filter(log => {
            if (!log.rawDate) return true;
            const logDate = new Date(log.rawDate).setHours(0,0,0,0);
            const start = startDate ? new Date(startDate).setHours(0,0,0,0) : null;
            const end = endDate ? new Date(endDate).setHours(0,0,0,0) : null;
            if (start && logDate < start) return false;
            if (end && logDate > end) return false;
            return true;
          });
        }, [logs, startDate, endDate]);

        // "Surgical Strike" Query
        useEffect(() => {
          async function validateLogin() {
            if (combinedCode.length === 8 && !isVerifying) {
              setIsVerifying(true);
              const districtInput = combinedCode.substring(0, 4).toUpperCase().trim();
              const pinInput = combinedCode.substring(4, 8).trim();
              const docId = `${districtInput}-${pinInput}`;

              try {
                const userDoc = await db.collection("users").doc(docId).get();
                
                if (!userDoc.exists) {
                  triggerNotify(`Access Denied: Invalid credentials.`);
                  setCombinedCode("");
                  setIsVerifying(false);
                  return;
                }

                const userData = userDoc.data();
                if (userData.status !== "active") {
                  triggerNotify("Access Denied: Account inactive.");
                  setCombinedCode("");
                  setIsVerifying(false);
                  return;
                }

                // If Admin, bypass GPS
                if (userData.role === "admin") {
                  setUser(userData);
                  setCombinedCode("");
                  setIsVerifying(false);
                  return;
                }

                // Staff Location Check
                const locInfo = scheduleList.find(s => s.schoolName === userData.schoolName);
                if (locInfo && !isNaN(locInfo.lat)) {
                  navigator.geolocation.getCurrentPosition(
                    (pos) => {
                      const dist = getDistance(pos.coords.latitude, pos.coords.longitude, locInfo.lat, locInfo.lon);
                      if (dist <= locInfo.radius) {
                        setUser(userData);
                        setCombinedCode("");
                      } else {
                        triggerNotify(`Out of Range: ${dist.toFixed(2)}km away.`);
                        setCombinedCode("");
                      }
                      setIsVerifying(false);
                    },
                    () => {
                      triggerNotify("GPS Error: Location required.");
                      setCombinedCode("");
                      setIsVerifying(false);
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                  );
                } else {
                  // No specific geofence for this school, allow entry
                  setUser(userData);
                  setCombinedCode("");
                  setIsVerifying(false);
                }
              } catch (err) {
                triggerNotify("Connection Error");
                setIsVerifying(false);
              }
            }
          }
          validateLogin();
        }, [combinedCode, scheduleList]);

        const downloadCSV = (data, filename) => {
          const headers = ["Employee", "Campus", "District", "Type", "Date", "Time", "Late", "Late Time"];
          const csvRows = [headers.join(",")];
          data.forEach(log => {
            csvRows.push([`"${log.employee}"`, `"${log.campus}"`, `"${log.districtCode}"`, log.type, log.dateOnly, log.time.split(',')[1]?.trim() || "", log.isLate ? "YES" : "NO", `"${log.lateMinutes || ''}"`].join(","));
          });
          const blob = new Blob([csvRows.join("\n")], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = `${filename}.csv`; a.click();
        };

        const calculateStats = (staffLogs) => {
          const now = new Date();
          const currentWeekStart = new Date();
          currentWeekStart.setDate(now.getDate() - now.getDay());
          currentWeekStart.setHours(0,0,0,0);
          
          let lateWeek = 0; let lateMonth = 0;
          staffLogs.forEach(log => {
            if(log.isLate && log.rawDate) {
              const d = new Date(log.rawDate);
              if(d >= currentWeekStart) lateWeek++;
            }
          });
          return { lateWeek, uniqueDays: new Set(staffLogs.map(l => l.dateOnly)).size };
        };

        const clock = async (type) => {
          const now = new Date();
          const todayStr = now.toLocaleDateString();
          const myLogsToday = logs.filter(l => l.employee === user.name && l.dateOnly === todayStr);
          
          if (type === "IN" && myLogsToday.some(l => l.type === "OUT")) {
            triggerNotify("Restricted: Already clocked out today.");
            return;
          }

          let isLate = false, diffStr = "";
          if (type === "IN") {
            const sched = scheduleList.find(s => s.schoolName === user.schoolName);
            if (sched && sched.lateTime) {
              const [h, m] = sched.lateTime.split(':');
              const lateBoundary = new Date(); lateBoundary.setHours(parseInt(h), parseInt(m), 0);
              if (now > lateBoundary && !myLogsToday.some(l => l.isLate)) {
                isLate = true; 
                diffStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); 
              }
            }
          }

          const entry = { employee: user.name, districtCode: user.districtCode, type, campus: user.schoolName, timestamp: firebase.firestore.FieldValue.serverTimestamp(), dateOnly: todayStr, isLate, lateMinutes: diffStr };
          try {
            await db.collection("logs").add(entry);
            setLastClockInfo(`Clocked ${type}`);
            setTimer(user.role === 'admin' ? 300 : 60); 
            const msg = new SpeechSynthesisUtterance(type === "IN" ? `Hello ${user.name.split(' ')[0]}` : "Goodbye");
            window.speechSynthesis.speak(msg);
          } catch (e) { triggerNotify("Cloud Sync Error!"); }
        };

        const pageStyle = { minHeight: "100vh", display: "flex", justifyContent: "center", alignItems: "center", background: "linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)", color: "#fff", padding: "10px", boxSizing: "border-box" };
        const cardStyle = { background: "rgba(255,255,255,0.12)", backdropFilter: "blur(15px)", padding: "30px", borderRadius: 24, width: "100%", maxWidth: user?.role === 'admin' ? "900px" : "360px", boxShadow: "0 20px 45px rgba(0,0,0,0.4)", border: "1px solid rgba(255,255,255,0.1)", position: "relative", boxSizing: "border-box" };
        const inputBase = { width: "100%", padding: "14px", borderRadius: "10px", border: "none", fontSize: "16px", background: "rgba(255,255,255,0.9)", color: "#333", boxSizing: "border-box" };

        if (loading) return <div style={pageStyle}><h2>Connecting...</h2></div>;

        if (!user) {
          return (
            <div style={pageStyle}>
              <div style={{...cardStyle, textAlign: "center"}} className="card-container">
                {isVerifying && (
                  <div style={{ position: "absolute", top: 0, left: 0, right: 0, bottom: 0, background: "rgba(0,0,0,0.8)", display: "flex", flexDirection: "column", justifyContent: "center", alignItems: "center", zIndex: 10, borderRadius: 24 }}>
                    <div className="status-dot dot-active loading-pulse" style={{width: 25, height: 25, marginBottom: 15}}></div>
                    <div style={{fontSize: "12px", fontWeight: "bold", letterSpacing: "1px"}}>VERIFYING...</div>
                  </div>
                )}
                <div style={{ fontSize: "36px", fontWeight: "bold" }}>{currentTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                <div style={{ fontSize: "14px", opacity: 0.7, marginBottom: "20px" }}>{currentTime.toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' })}</div>
                <img src={LOGO_URL} alt="Logo" style={{ maxWidth: "130px", marginBottom: "15px" }} />
                <input type="password" maxLength="8" disabled={isVerifying} placeholder="8-Digit Code" value={combinedCode} onChange={e => setCombinedCode(e.target.value)} style={{...inputBase, textAlign: "center"}} />
                <div style={{ fontSize: "10px", marginTop: "10px", opacity: 0.6 }}>District Code + PIN</div>
              </div>
            </div>
          );
        }

        const myTodayLogs = logs.filter(l => l.employee === user.name && l.dateOnly === new Date().toLocaleDateString());
        const lastAction = myTodayLogs.length > 0 ? myTodayLogs[0].type : "OUT";

        return (
          <div style={pageStyle} onClick={() => setTimer(user.role === 'admin' ? 300 : 60)}>
            <div style={cardStyle} className="card-container">
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "25px" }}>
                <div><h1 style={{ margin: "0", fontSize: "22px" }}>{user.name}</h1><p style={{ margin: "0", opacity: 0.7, fontSize: "12px" }}>{user.schoolName}</p></div>
                <div style={{ textAlign: "right" }}><div style={{ fontSize: "10px", opacity: 0.5 }}>Reset: {formatTimer(timer)}</div></div>
              </div>

              {user.role === 'admin' ? (
                <div>
                   <div className="admin-controls-flex" style={{ display: "flex", gap: "10px", marginBottom: "15px" }}>
                    <input type="text" placeholder="Search logs..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} style={{...inputBase, height: "35px", fontSize: "13px"}} />
                  </div>
                  <div className="scroll-box" style={{ maxHeight: "350px", overflowY: "auto", background: "rgba(0,0,0,0.15)", borderRadius: "12px" }}>
                    <table style={{ width: "100%", borderCollapse: "collapse", fontSize: "13px" }}>
                      <thead style={{ position: "sticky", top: 0, background: "#254885" }}><tr style={{ textAlign: "left" }}><th style={{ padding: "12px" }}>Employee</th><th style={{ padding: "12px" }}>Activity</th></tr></thead>
                      <tbody>
                        {filteredLogs.filter(l => l.employee.toLowerCase().includes(searchTerm.toLowerCase()) && l.districtCode === user.districtCode).map(log => (
                           <tr key={log.id} style={{ borderBottom: "1px solid rgba(255,255,255,0.05)" }}>
                              <td style={{ padding: "12px" }}>{log.employee}</td>
                              <td style={{ padding: "12px" }}>{log.type} @ {log.time.split(',')[1]}</td>
                           </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                  <button onClick={() => downloadCSV(filteredLogs, "Report")} style={{ width: "100%", padding: "10px", borderRadius: "10px", background: "#4db6ac", color: "white", marginTop: "15px", border: "none", cursor: "pointer" }}>Download CSV</button>
                </div>
              ) : (
                <div>
                  <button onClick={() => clock(lastAction === "OUT" ? "IN" : "OUT")} style={{ ...inputBase, background: lastAction === "OUT" ? "#4db6ac" : "#ff8a65", color: "white", fontWeight: "bold", cursor: "pointer", marginBottom: "20px" }}>
                    Clock {lastAction === "OUT" ? "In" : "Out"}
                  </button>
                  <div className="scroll-box" style={{maxHeight: "200px", overflowY: "auto"}}>
                    {logs.filter(l => l.employee === user.name).slice(0, 5).map(log => (
                      <div key={log.id} className="history-item">
                        <span>{log.type} at {log.time.split(',')[1]}</span>
                        <span style={{opacity: 0.6}}>{log.dateOnly}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}
              <button onClick={handleLogout} style={{ width: "100%", padding: "12px", borderRadius: "10px", border: "1px solid rgba(255,255,255,0.3)", background: "transparent", color: "white", cursor: "pointer", marginTop: "20px" }}>Log Out</button>
            </div>
          </div>
        );
      }
      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
